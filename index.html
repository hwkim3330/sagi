<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#FDF6F0">
<title>SAGI</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23E8756B'/><stop offset='1' stop-color='%23D4614F'/></linearGradient></defs><rect width='200' height='200' rx='44' fill='url(%23g)'/><circle cx='78' cy='100' r='18' fill='white'/><path d='M112 72Q128 100 112 128' stroke='white' stroke-width='6' fill='none' stroke-linecap='round'/><path d='M128 58Q152 100 128 142' stroke='white' stroke-width='6' fill='none' stroke-linecap='round' opacity='.6'/></svg>">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#FAF6F1;--bg2:#F5EFE8;--surface:#fff;--accent:#D4614F;--accent2:#E8756B;
  --accent-light:#FFF0ED;--text:#1A1A1A;--text-sec:#999;
  --border:rgba(0,0,0,.06);--shadow:0 1px 8px rgba(0,0,0,.05);
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'Pretendard Variable',Pretendard,-apple-system,'Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;
}
.screen{display:none;flex-direction:column;height:100dvh;position:absolute;inset:0;z-index:1}
.screen.active{display:flex}

/* ===== SELECT ===== */
#select-screen{
  align-items:center;justify-content:center;gap:24px;padding:24px;
  background:var(--bg);overflow-y:auto;
}
.sel-logo{width:64px;height:64px;margin-bottom:-4px}
.sel-title{font-size:32px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text}
.sel-sub{font-size:14px;color:var(--text-sec);text-align:center;max-width:340px;line-height:1.6}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;
  max-width:520px;width:100%}
.card{
  background:var(--surface);border-radius:14px;padding:18px 14px;cursor:pointer;
  border:1.5px solid var(--border);transition:all .2s;text-align:center;position:relative;
}
.card:hover{border-color:var(--accent2);box-shadow:0 4px 20px rgba(212,97,79,.12)}
.card:active{transform:scale(.98)}
.card .ic{font-size:28px;margin-bottom:8px}
.card .nm{font-size:14px;font-weight:700;margin-bottom:2px}
.card .ds{font-size:11px;color:var(--text-sec);margin-bottom:6px;line-height:1.4}
.card .sz{font-size:10px;color:var(--accent);font-weight:600;
  background:var(--accent-light);padding:2px 8px;border-radius:10px;display:inline-block}
.card .lang{font-size:9px;color:var(--text-sec);margin-top:5px;font-weight:500}
.card .badge{position:absolute;top:8px;right:8px;font-size:9px;color:white;
  background:var(--accent);padding:2px 6px;border-radius:6px;font-weight:600}
.sel-foot{font-size:11px;color:var(--text-sec);text-align:center;line-height:1.5}

/* ===== LOADING ===== */
#loading-screen{align-items:center;justify-content:center;gap:20px;background:var(--bg)}
.ld-logo{width:56px;height:56px;animation:breathe 2.5s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.06);opacity:.8}}
.ld-title{font-size:18px;font-weight:700}
.ld-bars{width:260px;display:flex;flex-direction:column;gap:10px}
.ld-bars label{font-size:11px;color:var(--text-sec);display:flex;justify-content:space-between;margin-bottom:3px}
.bar-track{height:4px;background:rgba(0,0,0,.06);border-radius:2px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));
  border-radius:2px;transition:width .3s;width:0%}
.ld-status{font-size:12px;color:var(--text-sec);text-align:center;max-width:260px}

/* ===== CHAT ===== */
#chat-screen{background:var(--bg)}
.hdr{
  display:flex;align-items:center;gap:8px;padding:10px 16px;
  background:rgba(250,246,241,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);z-index:10;
  padding-top:max(10px,env(safe-area-inset-top));
}
.hdr svg{width:28px;height:28px;flex-shrink:0}
.hdr-title{font-size:16px;font-weight:700;flex:1}
.hdr-tag{font-size:10px;color:var(--accent);background:var(--accent-light);
  padding:2px 7px;border-radius:8px;font-weight:600}
.hdr-btn{background:none;border:none;cursor:pointer;padding:5px;border-radius:8px;
  color:var(--text-sec);transition:all .15s;font-size:16px}
.hdr-btn:hover{background:rgba(0,0,0,.05)}
.hdr-btn.on{color:var(--accent)}

.chat{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;
  overscroll-behavior:contain}

.m{display:flex;gap:6px;max-width:82%;animation:mIn .2s ease-out}
@keyframes mIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.m.u{align-self:flex-end;flex-direction:row-reverse}
.m.a{align-self:flex-start}
.m-av{width:26px;height:26px;border-radius:50%;flex-shrink:0;display:flex;
  align-items:center;justify-content:center;font-size:12px}
.m.u .m-av{background:linear-gradient(135deg,var(--accent2),var(--accent));color:white}
.m.a .m-av{background:var(--bg2);color:var(--text-sec)}
.m-body{display:flex;flex-direction:column;gap:3px}
.m-bub{padding:9px 13px;border-radius:16px;font-size:14px;line-height:1.55;word-break:break-word}
.m.u .m-bub{background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  border-bottom-right-radius:4px}
.m.a .m-bub{background:var(--surface);border-bottom-left-radius:4px;box-shadow:var(--shadow)}
.m-bub img{max-width:180px;max-height:180px;border-radius:10px;display:block;margin-bottom:4px}
.m-act{display:flex;gap:4px;padding:0 4px}
.m.u .m-act{justify-content:flex-end}
.sp-btn{background:none;border:none;cursor:pointer;padding:1px 5px;border-radius:5px;
  font-size:12px;color:var(--text-sec);transition:all .15s}
.sp-btn:hover{color:var(--accent)}
.sp-btn.speaking{color:var(--accent);animation:breathe 1s ease-in-out infinite}

.dots{display:flex;gap:3px;padding:8px 12px;align-items:center}
.dots span{width:5px;height:5px;border-radius:50%;background:var(--text-sec);
  animation:dot 1.2s ease-in-out infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,60%,100%{opacity:.3}30%{opacity:1;transform:translateY(-4px)}}

/* ===== INPUT ===== */
.inp{
  display:flex;flex-direction:column;gap:6px;padding:10px 14px;
  background:rgba(250,246,241,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding-bottom:max(10px,env(safe-area-inset-bottom));
}
.img-pv{display:none;position:relative;width:fit-content}
.img-pv.on{display:block}
.img-pv img{height:52px;border-radius:8px;display:block}
.img-pv .rm{position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  border-radius:50%;background:var(--accent);color:white;border:2px solid var(--bg);
  cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;line-height:1}
.inp-row{display:flex;align-items:flex-end;gap:6px}
.inp-row textarea{
  flex:1;resize:none;border:none;outline:none;background:var(--surface);
  border-radius:20px;padding:9px 14px;font-size:14px;font-family:inherit;
  max-height:100px;line-height:1.4;box-shadow:var(--shadow);
}
.inp-row textarea::placeholder{color:#bbb}
.ib{
  width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;
  background:var(--surface);color:var(--text-sec);font-size:15px;
  display:none;align-items:center;justify-content:center;flex-shrink:0;
  box-shadow:var(--shadow);transition:all .15s;
}
.ib.vis{display:flex}
.ib:hover{color:var(--accent)}
.sb{
  width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  font-size:15px;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;
}
.sb:disabled{opacity:.25;cursor:default}
.sb:not(:disabled):hover{transform:scale(1.06)}
.sb.gen{background:linear-gradient(135deg,#FF9500,#E88000)}

/* ===== SETTINGS ===== */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:100;
  display:none;align-items:flex-end;justify-content:center}
.ov.on{display:flex}
.pan{
  background:var(--surface);border-radius:18px 18px 0 0;padding:20px;width:100%;max-width:420px;
  max-height:55vh;overflow-y:auto;animation:up .25s ease-out;
}
@keyframes up{from{transform:translateY(100%)}to{transform:none}}
.pan h3{font-size:16px;font-weight:700;margin-bottom:14px}
.sr{display:flex;align-items:center;justify-content:space-between;padding:10px 0;
  border-bottom:1px solid var(--border)}
.sr:last-child{border-bottom:none}
.sl{font-size:14px;font-weight:500}
.sd{font-size:11px;color:var(--text-sec);margin-top:1px}
.tg{width:42px;height:24px;border-radius:12px;background:#ccc;cursor:pointer;
  position:relative;transition:background .2s;border:none;padding:0;flex-shrink:0}
.tg.on{background:var(--accent)}
.tg::after{content:'';position:absolute;width:20px;height:20px;border-radius:50%;
  background:white;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 2px rgba(0,0,0,.15)}
.tg.on::after{transform:translateX(18px)}

@media(max-width:480px){
  .cards{grid-template-columns:1fr 1fr}
  .m{max-width:88%}
}
@media(max-width:360px){
  .cards{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ===== SELECT ===== -->
<div id="select-screen" class="screen active">
  <svg class="sel-logo" viewBox="0 0 200 200">
    <defs><linearGradient id="lg1" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
    </linearGradient></defs>
    <rect width="200" height="200" rx="44" fill="url(#lg1)"/>
    <circle cx="78" cy="100" r="18" fill="white"/>
    <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
  </svg>
  <div class="sel-title">SAGI</div>
  <div class="sel-sub">브라우저에서 실행되는 AI 음성 어시스턴트.<br>모델을 선택하세요.</div>
  <div class="cards" id="cards"></div>
  <div class="sel-foot">WebGPU 가속 &middot; 서버 불필요 &middot; 완전 로컬</div>
</div>

<!-- ===== LOADING ===== -->
<div id="loading-screen" class="screen">
  <svg class="ld-logo" viewBox="0 0 200 200">
    <defs><linearGradient id="lg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
    </linearGradient></defs>
    <rect width="200" height="200" rx="44" fill="url(#lg2)"/>
    <circle cx="78" cy="100" r="18" fill="white"/>
    <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
  </svg>
  <div class="ld-title" id="ld-title">Loading...</div>
  <div class="ld-bars">
    <div>
      <label><span>Language Model</span><span id="llm-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="llm-bar"></div></div>
    </div>
    <div id="tts-bar-group" style="display:none">
      <label><span>Voice Engine</span><span id="tts-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="tts-bar"></div></div>
    </div>
  </div>
  <div class="ld-status" id="ld-status">Initializing WebGPU...</div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat-screen" class="screen">
  <div class="hdr">
    <svg viewBox="0 0 200 200" style="width:28px;height:28px">
      <defs><linearGradient id="lg3" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
      </linearGradient></defs>
      <rect width="200" height="200" rx="44" fill="url(#lg3)"/>
      <circle cx="78" cy="100" r="18" fill="white"/>
      <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    </svg>
    <span class="hdr-title">SAGI</span>
    <span class="hdr-tag" id="tag"></span>
    <button class="hdr-btn on" id="tts-btn" title="TTS">&#x1f50a;</button>
    <button class="hdr-btn" id="set-btn" title="Settings">&#x2699;</button>
  </div>
  <div class="chat" id="chat"></div>
  <div class="inp">
    <div class="img-pv" id="img-pv">
      <img id="img-pv-src">
      <button class="rm" id="img-rm">&times;</button>
    </div>
    <div class="inp-row">
      <button class="ib" id="ib" title="이미지 추가">&#x1f4f7;</button>
      <textarea id="ta" rows="1" placeholder="메시지를 입력하세요..." disabled></textarea>
      <button class="sb" id="sb" disabled>&#x2191;</button>
    </div>
    <input type="file" id="fi" accept="image/*" hidden>
  </div>
</div>

<!-- ===== SETTINGS ===== -->
<div class="ov" id="ov">
  <div class="pan">
    <h3>설정</h3>
    <div class="sr">
      <div><div class="sl">자동 음성 읽기</div><div class="sd">AI 응답을 TTS로 읽음</div></div>
      <button class="tg on" id="tg-auto"></button>
    </div>
    <div class="sr">
      <div><div class="sl">음성</div><div class="sd">TTS 화자</div></div>
      <select id="voice-sel" style="font-size:13px;padding:3px 6px;border-radius:6px;border:1px solid var(--border);font-family:inherit">
        <option value="F1">여성 1</option><option value="F3">여성 3</option><option value="F5">여성 5</option>
        <option value="M1">남성 1</option><option value="M3">남성 3</option><option value="M5">남성 5</option>
      </select>
    </div>
    <div class="sr">
      <div><div class="sl">속도</div><div class="sd">TTS 재생 속도</div></div>
      <input type="range" id="spd" min="0.8" max="1.3" step="0.05" value="1.0"
        style="width:90px;accent-color:var(--accent)">
    </div>
    <div class="sr" style="border-bottom:none;justify-content:center">
      <button onclick="document.getElementById('ov').classList.remove('on')"
        style="padding:8px 28px;border-radius:10px;border:none;background:var(--accent);color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">
        완료
      </button>
    </div>
  </div>
</div>

<script type="module">
import {
  pipeline, TextStreamer, InterruptableStoppingCriteria,
} from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@next";

/* ===== CONFIG ===== */
const MODELS = {
  falcon: {
    id: "onnx-community/Falcon-H1-Tiny-90M-Instruct-ONNX",
    name: "Falcon 90M", icon: "\u26a1", desc: "빠르고 가벼움",
    size: "~180 MB", lang: "EN / KO",
    dtype: "fp16", task: "text-generation",
    sample: false, maxTokens: 512,
  },
  lfm: {
    id: "onnx-community/LFM2-1.2B-ONNX",
    name: "LFM2 1.2B", icon: "\u{1f9e0}", desc: "스마트",
    size: "~700 MB", lang: "Multilingual",
    dtype: "q4f16", task: "text-generation",
    sample: true, temp: 0.7, maxTokens: 512,
  },
  vlm: {
    id: "onnx-community/LFM2-VL-450M-ONNX",
    name: "LFM2-VL", icon: "\u{1f441}\ufe0f", desc: "이미지+대화",
    size: "~300 MB", lang: "Vision",
    dtype: "q4", task: "image-text-to-text",
    sample: true, temp: 0.7, maxTokens: 256, isVL: true,
  },
};

const TTS_ID = "onnx-community/Supertonic-TTS-2-ONNX";
const TTS_VOICE = "https://huggingface.co/onnx-community/Supertonic-TTS-2-ONNX/resolve/main/voices";

const SYS = {
  role: "system",
  content: "너는 SAGI라는 친절한 AI 어시스턴트야. 간결하고 자연스럽게 답해. 사용자가 한국어로 말하면 한국어로, 영어로 말하면 영어로 답해.",
};

/* ===== STATE ===== */
let gen = null, tts = null, msgs = [SYS];
let busy = false, autoSpeak = true, curKey = null;
let audioCtx = null, curSrc = null, pendImg = null;
const stop = new InterruptableStoppingCriteria();

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const chat = $("chat"), ta = $("ta"), sb = $("sb");
const ib = $("ib"), fi = $("fi"), imgPv = $("img-pv"), imgSrc = $("img-pv-src");

/* ===== CLEANUP: force-remove old COI SW that blocks Workers ===== */
if ("serviceWorker" in navigator && window.crossOriginIsolated) {
  navigator.serviceWorker.getRegistrations().then(async regs => {
    for (const r of regs) await r.unregister();
    sessionStorage.removeItem("coi");
    location.reload();
  });
}

/* ===== MODEL CARDS ===== */
const ce = $("cards");
for (const [k, m] of Object.entries(MODELS)) {
  const c = document.createElement("div");
  c.className = "card";
  c.innerHTML = `<div class="ic">${m.icon}</div><div class="nm">${m.name}</div>
    <div class="ds">${m.desc}</div><div class="sz">${m.size}</div>
    <div class="lang">${m.lang}</div>
    ${m.isVL ? '<div class="badge">Vision</div>' : ""}`;
  c.onclick = () => load(k);
  ce.appendChild(c);
}

function show(n) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  $(n + "-screen").classList.add("active");
}

/* ===== LOAD ===== */
async function load(key) {
  curKey = key;
  const m = MODELS[key];
  show("loading");
  $("ld-title").textContent = `${m.name} 로딩 중...`;
  $("ld-status").textContent = "WebGPU 초기화...";
  $("llm-bar").style.width = "0%"; $("llm-pct").textContent = "0%";
  $("tts-bar").style.width = "0%"; $("tts-pct").textContent = "0%";

  const lf = new Map(), tf = new Map();
  const ub = (f, bid, pid) => {
    if (f.size < 2) return;
    let ld = 0, tt = 0;
    for (const v of f.values()) { ld += v.loaded; tt += v.total; }
    const p = tt > 0 ? Math.round(ld/tt*100) : 0;
    $(bid).style.width = p + "%"; $(pid).textContent = p + "%";
  };

  // LLM
  try {
    $("ld-status").textContent = `${m.name} 다운로드 중...`;
    gen = await pipeline(m.task, m.id, {
      dtype: m.dtype, device: "webgpu",
      progress_callback: ({status,file,loaded,total}) => {
        if (status==="progress") { lf.set(file,{loaded,total}); ub(lf,"llm-bar","llm-pct"); }
      },
    });
  } catch(e) {
    console.warn("WebGPU fail, WASM fallback:", e);
    $("ld-status").textContent = "WebGPU 불가, WASM 사용...";
    lf.clear();
    gen = await pipeline(m.task, m.id, {
      dtype: m.dtype==="fp16"?"fp32":"q4", device: "wasm",
      progress_callback: ({status,file,loaded,total}) => {
        if (status==="progress") { lf.set(file,{loaded,total}); ub(lf,"llm-bar","llm-pct"); }
      },
    });
  }
  $("llm-bar").style.width = "100%"; $("llm-pct").textContent = "100%";

  // TTS: Supertonic-TTS-2-ONNX not compatible with transformers.js pipeline yet
  // (missing preprocessor_config.json). Skip for now.
  tts = null;
  $("tts-bar").style.width = "100%";
  $("tts-pct").textContent = "—";

  // Ready
  $("tag").textContent = m.name;
  if (m.isVL) ib.classList.add("vis");
  if (!tts) $("tts-btn").style.display = "none";
  ta.disabled = false; ta.focus();
  show("chat");
  welcome();
}

/* ===== MESSAGES ===== */
function welcome() {
  const m = MODELS[curKey];
  const t = m.isVL ? "안녕하세요! 이미지를 보내거나 질문해주세요."
    : "안녕하세요! 무엇이든 물어보세요.";
  addMsg("a", t);
}

function addMsg(role, text, imgUrl) {
  const d = document.createElement("div");
  d.className = `m ${role}`;
  const av = document.createElement("div");
  av.className = "m-av";
  av.textContent = role === "u" ? "\u{1f464}" : "\u{1f50a}";
  const body = document.createElement("div");
  body.className = "m-body";
  const bub = document.createElement("div");
  bub.className = "m-bub";
  if (imgUrl) { const i = document.createElement("img"); i.src = imgUrl; bub.appendChild(i); }
  if (text) bub.appendChild(document.createTextNode(text));
  body.appendChild(bub);

  if (role === "a" && tts) {
    const act = document.createElement("div"); act.className = "m-act";
    const sp = document.createElement("button"); sp.className = "sp-btn";
    sp.textContent = "\u{1f50a}"; sp.title = "읽기";
    sp.onclick = () => { const t = bub.textContent; if (t?.trim()) speak(t, sp); };
    act.appendChild(sp); body.appendChild(act);
  }

  d.appendChild(av); d.appendChild(body);
  chat.appendChild(d);
  requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
  return bub;
}

function showDots() {
  const d = document.createElement("div");
  d.className = "m a"; d.id = "dots";
  d.innerHTML = `<div class="m-av">\u{1f50a}</div><div class="m-body"><div class="m-bub"><div class="dots"><span></span><span></span><span></span></div></div></div>`;
  chat.appendChild(d);
  requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
}
function hideDots() { $("dots")?.remove(); }

/* ===== GENERATE ===== */
async function generate() {
  if (busy) { stop.interrupt(); return; }
  const text = ta.value.trim();
  const hasImg = !!pendImg;
  if (!text && !hasImg) return;

  const imgUrl = pendImg;
  ta.value = ""; ta.style.height = "auto"; clrImg(); updBtn();

  const m = MODELS[curKey];
  let content;
  if (m.isVL && hasImg) {
    content = [];
    content.push({ type: "image", image: imgUrl });
    content.push({ type: "text", text: text || "이 이미지를 설명해주세요." });
  } else {
    content = text;
  }

  msgs.push({ role: "user", content });
  addMsg("u", text || "(이미지)", hasImg ? imgUrl : null);
  showDots();

  busy = true; sb.classList.add("gen"); stop.reset();
  hideDots();
  const bub = addMsg("a", "");
  let res = "";

  const opts = { max_new_tokens: m.maxTokens, do_sample: m.sample, stopping_criteria: stop };
  if (m.sample && m.temp) opts.temperature = m.temp;

  if (m.isVL) {
    try {
      const out = await gen(msgs, opts);
      res = typeof out === "string" ? out
        : Array.isArray(out) ? (out[0]?.generated_text ?? out[0]?.text ?? JSON.stringify(out))
        : (out?.generated_text ?? out?.text ?? JSON.stringify(out));
      if (typeof res === "object") res = JSON.stringify(res);
      bub.textContent = res;
    } catch(e) {
      console.error("VL error:", e);
      bub.textContent = "(오류: " + e.message + ")";
    }
  } else {
    opts.streamer = new TextStreamer(gen.tokenizer, {
      skip_prompt: true, skip_special_tokens: true,
      callback_function: tok => {
        res += tok; bub.textContent = res;
        requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
      },
    });
    try { await gen(msgs, opts); }
    catch(e) { console.error("Gen error:", e); if (!res) bub.textContent = "(생성 실패)"; }
  }

  msgs.push({ role: "assistant", content: res });
  busy = false; sb.classList.remove("gen"); updBtn(); ta.focus();

  if (autoSpeak && tts && res.trim()) {
    const sp = bub.closest(".m-body")?.querySelector(".sp-btn");
    speak(res, sp);
  }
}

/* ===== IMAGE ===== */
function attachImg(url) { pendImg = url; imgSrc.src = url; imgPv.classList.add("on"); updBtn(); }
function clrImg() { pendImg = null; imgSrc.src = ""; imgPv.classList.remove("on"); }
ib.addEventListener("click", () => fi.click());
fi.addEventListener("change", e => {
  const f = e.target.files?.[0]; if (!f) return;
  const r = new FileReader(); r.onload = () => attachImg(r.result); r.readAsDataURL(f);
  fi.value = "";
});
$("img-rm").addEventListener("click", clrImg);
document.addEventListener("paste", e => {
  if (!MODELS[curKey]?.isVL) return;
  for (const it of e.clipboardData?.items || []) {
    if (it.type.startsWith("image/")) {
      e.preventDefault();
      const r = new FileReader(); r.onload = () => attachImg(r.result);
      r.readAsDataURL(it.getAsFile()); break;
    }
  }
});

/* ===== TTS ===== */
function detectLang(t) { return /[\u3131-\u3163\uac00-\ud7a3]/.test(t) ? "ko" : "en"; }

async function speak(text, btn) {
  if (!tts) return;
  if (curSrc) { try { curSrc.stop(); } catch{} curSrc = null; }
  if (btn) btn.classList.add("speaking");
  try {
    const lang = detectLang(text);
    const voice = $("voice-sel")?.value || "F1";
    const speed = parseFloat($("spd")?.value || "1.0");
    const r = await tts(`<${lang}>${text}</${lang}>`, {
      speaker_embeddings: `${TTS_VOICE}/${voice}.bin`,
      num_inference_steps: 5, speed,
    });
    if (!audioCtx) audioCtx = new AudioContext();
    const buf = audioCtx.createBuffer(1, r.audio.length, r.sampling_rate);
    buf.getChannelData(0).set(r.audio);
    const src = audioCtx.createBufferSource();
    src.buffer = buf; src.connect(audioCtx.destination);
    curSrc = src;
    src.onended = () => { if (btn) btn.classList.remove("speaking"); curSrc = null; };
    src.start();
  } catch(e) { console.error("TTS err:", e); if (btn) btn.classList.remove("speaking"); }
}

/* ===== EVENTS ===== */
sb.addEventListener("click", generate);
ta.addEventListener("keydown", e => { if (e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); generate(); }});
ta.addEventListener("input", () => {
  ta.style.height = "auto"; ta.style.height = Math.min(ta.scrollHeight, 100) + "px"; updBtn();
});
function updBtn() { sb.disabled = (!ta.value.trim() && !pendImg) && !busy; }

// TTS toggle
const ttsBtn = $("tts-btn");
ttsBtn.addEventListener("click", () => {
  autoSpeak = !autoSpeak;
  ttsBtn.classList.toggle("on", autoSpeak);
  $("tg-auto").classList.toggle("on", autoSpeak);
});
$("tg-auto").addEventListener("click", function() {
  autoSpeak = !autoSpeak;
  this.classList.toggle("on", autoSpeak);
  ttsBtn.classList.toggle("on", autoSpeak);
});

$("set-btn").addEventListener("click", () => $("ov").classList.add("on"));
$("ov").addEventListener("click", e => { if (e.target === $("ov")) $("ov").classList.remove("on"); });

chat.addEventListener("dblclick", () => {
  if (busy) return;
  if (confirm("대화 기록을 삭제할까요?")) { msgs = [SYS]; chat.innerHTML = ""; welcome(); }
});
</script>
</body>
</html>
