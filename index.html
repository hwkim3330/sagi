<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#FDF6F0">
<title>SAGI</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23E8756B'/><stop offset='1' stop-color='%23D4614F'/></linearGradient></defs><rect width='200' height='200' rx='44' fill='url(%23g)'/><circle cx='78' cy='100' r='18' fill='white'/><path d='M112 72Q128 100 112 128' stroke='white' stroke-width='6' fill='none' stroke-linecap='round'/><path d='M128 58Q152 100 128 142' stroke='white' stroke-width='6' fill='none' stroke-linecap='round' opacity='.6'/></svg>">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#FBF7F2;--bg2:#F3EDE6;--surface:#fff;--surface2:#FAFAFA;
  --accent:#D4614F;--accent2:#E8756B;--accent3:#F09080;
  --accent-light:#FFF0ED;--accent-glow:rgba(232,117,107,.15);
  --text:#1D1D1F;--text-sec:#86868B;--text-ter:#AEAEB2;
  --border:rgba(0,0,0,.06);--shadow:0 2px 12px rgba(0,0,0,.06);
  --shadow-lg:0 8px 30px rgba(0,0,0,.08);
  --radius:16px;--radius-sm:10px;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'Pretendard Variable',Pretendard,-apple-system,'Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;
  letter-spacing:-.01em;
}
.screen{display:none;flex-direction:column;height:100dvh;position:absolute;inset:0;z-index:1}
.screen.active{display:flex}

/* ===== SELECT ===== */
#select-screen{
  align-items:center;justify-content:center;gap:28px;padding:28px;
  background:linear-gradient(180deg,var(--bg) 0%,#F5EDE4 100%);overflow-y:auto;
}
.sel-hero{display:flex;flex-direction:column;align-items:center;gap:12px}
.sel-logo{width:72px;height:72px;filter:drop-shadow(0 4px 16px rgba(212,97,79,.3))}
.sel-title{font-size:36px;font-weight:800;letter-spacing:-1.5px;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text}
.sel-sub{font-size:14px;color:var(--text-sec);text-align:center;max-width:360px;line-height:1.7;font-weight:400}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(148px,1fr));gap:12px;
  max-width:520px;width:100%}
.card{
  background:var(--surface);border-radius:var(--radius);padding:20px 16px;cursor:pointer;
  border:1.5px solid var(--border);transition:all .25s ease;text-align:center;position:relative;
  backdrop-filter:blur(10px);
}
.card:hover{border-color:var(--accent2);box-shadow:0 6px 24px rgba(212,97,79,.15);transform:translateY(-2px)}
.card:active{transform:scale(.97);transition:.1s}
.card .ic{font-size:32px;margin-bottom:10px;display:block}
.card .nm{font-size:14px;font-weight:700;margin-bottom:4px;color:var(--text)}
.card .ds{font-size:11px;color:var(--text-sec);margin-bottom:8px;line-height:1.4}
.card .meta{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.card .sz{font-size:10px;color:var(--accent);font-weight:600;
  background:var(--accent-light);padding:3px 8px;border-radius:8px}
.card .lang{font-size:10px;color:var(--text-ter);font-weight:500;
  background:var(--bg2);padding:3px 8px;border-radius:8px}
.card .badge{position:absolute;top:10px;right:10px;font-size:9px;color:white;
  background:linear-gradient(135deg,var(--accent2),var(--accent));padding:3px 8px;border-radius:8px;font-weight:600;
  box-shadow:0 2px 6px rgba(212,97,79,.3)}
.sel-foot{font-size:11px;color:var(--text-ter);text-align:center;line-height:1.5;letter-spacing:0}

/* ===== LOADING ===== */
#loading-screen{align-items:center;justify-content:center;gap:24px;
  background:linear-gradient(180deg,var(--bg) 0%,#F5EDE4 100%)}
.ld-logo{width:60px;height:60px;animation:breathe 2.5s ease-in-out infinite;
  filter:drop-shadow(0 4px 16px rgba(212,97,79,.3))}
@keyframes breathe{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.85}}
.ld-title{font-size:18px;font-weight:700;letter-spacing:-.3px}
.ld-bars{width:280px;display:flex;flex-direction:column;gap:14px}
.ld-bars label{font-size:11px;color:var(--text-sec);display:flex;justify-content:space-between;margin-bottom:4px;font-weight:500}
.bar-track{height:5px;background:rgba(0,0,0,.06);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent2),var(--accent));
  border-radius:3px;transition:width .3s ease;width:0%}
.ld-status{font-size:12px;color:var(--text-sec);text-align:center;max-width:280px;font-weight:400}

/* ===== CHAT ===== */
#chat-screen{background:var(--bg)}
.hdr{
  display:flex;align-items:center;gap:10px;padding:10px 16px;
  background:rgba(251,247,242,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);z-index:10;
  padding-top:max(10px,env(safe-area-inset-top));
}
.hdr svg{width:30px;height:30px;flex-shrink:0;filter:drop-shadow(0 1px 4px rgba(212,97,79,.2))}
.hdr-info{flex:1;display:flex;flex-direction:column;gap:1px}
.hdr-title{font-size:16px;font-weight:700;letter-spacing:-.3px}
.hdr-sub{font-size:10px;color:var(--text-sec);font-weight:500}
.hdr-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:var(--radius-sm);
  color:var(--text-sec);transition:all .15s;font-size:17px;position:relative}
.hdr-btn:hover{background:rgba(0,0,0,.04)}
.hdr-btn.on{color:var(--accent)}
.hdr-btn .dot{position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;
  background:var(--accent);display:none}
.hdr-btn.has-dot .dot{display:block}

.chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;
  overscroll-behavior:contain;scroll-behavior:smooth}

.m{display:flex;gap:8px;max-width:80%;animation:mIn .25s ease-out}
@keyframes mIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.m.u{align-self:flex-end;flex-direction:row-reverse}
.m.a{align-self:flex-start}
.m-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;
  align-items:center;justify-content:center;font-size:13px;font-weight:600}
.m.u .m-av{background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  box-shadow:0 2px 8px rgba(212,97,79,.25)}
.m.a .m-av{background:var(--bg2);color:var(--text-sec)}
.m-body{display:flex;flex-direction:column;gap:4px}
.m-bub{padding:10px 14px;border-radius:18px;font-size:14px;line-height:1.6;word-break:break-word}
.m.u .m-bub{background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  border-bottom-right-radius:4px;box-shadow:0 2px 8px rgba(212,97,79,.2)}
.m.a .m-bub{background:var(--surface);border-bottom-left-radius:4px;box-shadow:var(--shadow)}
.m-bub img{max-width:200px;max-height:200px;border-radius:12px;display:block;margin-bottom:6px}
.m-act{display:flex;gap:4px;padding:0 6px}
.m.u .m-act{justify-content:flex-end}
.sp-btn{background:none;border:none;cursor:pointer;padding:2px 6px;border-radius:6px;
  font-size:13px;color:var(--text-ter);transition:all .15s}
.sp-btn:hover{color:var(--accent)}
.sp-btn.speaking{color:var(--accent);animation:breathe 1s ease-in-out infinite}

.dots{display:flex;gap:4px;padding:8px 14px;align-items:center}
.dots span{width:6px;height:6px;border-radius:50%;background:var(--text-ter);
  animation:dot 1.4s ease-in-out infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-5px)}}

/* ===== INPUT ===== */
.inp{
  display:flex;flex-direction:column;gap:6px;padding:10px 14px;
  background:rgba(251,247,242,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--border);
  padding-bottom:max(10px,env(safe-area-inset-bottom));
}
/* voice bar */
.voice-bar{display:flex;align-items:center;gap:6px;padding:0 2px;overflow-x:auto;scrollbar-width:none}
.voice-bar::-webkit-scrollbar{display:none}
.voice-bar .vb-label{font-size:10px;color:var(--text-ter);font-weight:600;white-space:nowrap;letter-spacing:.5px;text-transform:uppercase}
.vchip{
  font-size:11px;padding:4px 10px;border-radius:14px;border:1.5px solid var(--border);
  background:var(--surface);color:var(--text-sec);cursor:pointer;white-space:nowrap;
  transition:all .2s;font-family:inherit;font-weight:500;
}
.vchip:hover{border-color:var(--accent-glow);background:var(--accent-light)}
.vchip.sel{background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  border-color:transparent;box-shadow:0 2px 8px rgba(212,97,79,.25)}
.voice-bar .vb-sep{width:1px;height:14px;background:var(--border);flex-shrink:0}
.voice-bar .spd-wrap{display:flex;align-items:center;gap:4px;margin-left:auto;flex-shrink:0}
.voice-bar .spd-wrap label{font-size:10px;color:var(--text-ter);font-weight:500}
.voice-bar .spd-wrap input{width:60px;accent-color:var(--accent)}

.img-pv{display:none;position:relative;width:fit-content}
.img-pv.on{display:block}
.img-pv img{height:56px;border-radius:10px;display:block;box-shadow:var(--shadow)}
.img-pv .rm{position:absolute;top:-6px;right:-6px;width:20px;height:20px;
  border-radius:50%;background:var(--accent);color:white;border:2px solid var(--bg);
  cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;line-height:1}
.inp-row{display:flex;align-items:flex-end;gap:6px}
.inp-row textarea{
  flex:1;resize:none;border:none;outline:none;background:var(--surface);
  border-radius:22px;padding:10px 16px;font-size:14px;font-family:inherit;
  max-height:100px;line-height:1.5;box-shadow:var(--shadow);
  transition:box-shadow .2s;
}
.inp-row textarea:focus{box-shadow:0 2px 12px rgba(212,97,79,.1)}
.inp-row textarea::placeholder{color:var(--text-ter)}
.circle-btn{
  width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;
  font-size:16px;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;
}
.ib{background:var(--surface);color:var(--text-sec);box-shadow:var(--shadow);display:none}
.ib.vis{display:flex}
.ib:hover{color:var(--accent)}
.mic-btn{background:var(--surface);color:var(--text-sec);box-shadow:var(--shadow)}
.mic-btn:hover{color:var(--accent)}
.mic-btn.rec{background:linear-gradient(135deg,#FF3B30,#FF6259);color:white;
  box-shadow:0 2px 12px rgba(255,59,48,.35);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{box-shadow:0 2px 12px rgba(255,59,48,.35)}50%{box-shadow:0 2px 20px rgba(255,59,48,.55)}}
.sb{
  background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;
  box-shadow:0 2px 8px rgba(212,97,79,.25);
}
.sb:disabled{opacity:.2;cursor:default;box-shadow:none}
.sb:not(:disabled):hover{transform:scale(1.06)}
.sb.gen{background:linear-gradient(135deg,#FF9500,#E88000);
  box-shadow:0 2px 8px rgba(255,149,0,.3)}

/* ===== SETTINGS ===== */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100;
  display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.ov.on{display:flex}
.pan{
  background:var(--surface);border-radius:20px 20px 0 0;padding:24px;width:100%;max-width:420px;
  max-height:55vh;overflow-y:auto;animation:up .3s cubic-bezier(.32,.72,0,1);
}
@keyframes up{from{transform:translateY(100%)}to{transform:none}}
.pan-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px}
.pan h3{font-size:17px;font-weight:700;margin-bottom:16px;letter-spacing:-.3px}
.sr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;
  border-bottom:1px solid var(--border)}
.sr:last-child{border-bottom:none}
.sl{font-size:14px;font-weight:500}
.sd{font-size:11px;color:var(--text-sec);margin-top:2px}
.tg{width:44px;height:26px;border-radius:13px;background:#D1D1D6;cursor:pointer;
  position:relative;transition:background .25s;border:none;padding:0;flex-shrink:0}
.tg.on{background:var(--accent)}
.tg::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;
  background:white;top:2px;left:2px;transition:transform .25s cubic-bezier(.32,.72,0,1);
  box-shadow:0 1px 3px rgba(0,0,0,.15)}
.tg.on::after{transform:translateX(18px)}

@media(max-width:480px){
  .cards{grid-template-columns:1fr 1fr}
  .m{max-width:88%}
}
@media(max-width:360px){
  .cards{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ===== SELECT ===== -->
<div id="select-screen" class="screen active">
  <div class="sel-hero">
    <svg class="sel-logo" viewBox="0 0 200 200">
      <defs><linearGradient id="lg1" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
      </linearGradient></defs>
      <rect width="200" height="200" rx="44" fill="url(#lg1)"/>
      <circle cx="78" cy="100" r="18" fill="white"/>
      <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
      <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
    </svg>
    <div class="sel-title">SAGI</div>
  </div>
  <div class="sel-sub">브라우저에서 실행되는 AI 음성 어시스턴트.<br>모델을 선택해 시작하세요.</div>
  <div class="cards" id="cards"></div>
  <div class="sel-foot">WebGPU 가속 &middot; 서버 불필요 &middot; 완전 로컬 &middot; 개인정보 보호</div>
</div>

<!-- ===== LOADING ===== -->
<div id="loading-screen" class="screen">
  <svg class="ld-logo" viewBox="0 0 200 200">
    <defs><linearGradient id="lg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
    </linearGradient></defs>
    <rect width="200" height="200" rx="44" fill="url(#lg2)"/>
    <circle cx="78" cy="100" r="18" fill="white"/>
    <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
  </svg>
  <div class="ld-title" id="ld-title">Loading...</div>
  <div class="ld-bars">
    <div>
      <label><span>Language Model</span><span id="llm-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="llm-bar"></div></div>
    </div>
    <div id="tts-bar-group" style="display:none">
      <label><span>Voice Engine (Supertonic)</span><span id="tts-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="tts-bar"></div></div>
    </div>
  </div>
  <div class="ld-status" id="ld-status">WebGPU 초기화 중...</div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat-screen" class="screen">
  <div class="hdr">
    <svg viewBox="0 0 200 200" style="width:30px;height:30px">
      <defs><linearGradient id="lg3" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
      </linearGradient></defs>
      <rect width="200" height="200" rx="44" fill="url(#lg3)"/>
      <circle cx="78" cy="100" r="18" fill="white"/>
      <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    </svg>
    <div class="hdr-info">
      <span class="hdr-title">SAGI</span>
      <span class="hdr-sub" id="hdr-sub"></span>
    </div>
    <button class="hdr-btn on" id="tts-btn" title="TTS on/off">&#x1f50a;<span class="dot"></span></button>
    <button class="hdr-btn" id="set-btn" title="설정">&#x2699;</button>
  </div>
  <div class="chat" id="chat"></div>
  <div class="inp">
    <div class="voice-bar" id="voice-bar">
      <span class="vb-label">Voice</span>
      <button class="vchip sel" data-v="F1">Sarah</button>
      <button class="vchip" data-v="F3">Jessica</button>
      <button class="vchip" data-v="F5">Emily</button>
      <span class="vb-sep"></span>
      <button class="vchip" data-v="M1">Alex</button>
      <button class="vchip" data-v="M3">Robert</button>
      <button class="vchip" data-v="M5">Daniel</button>
      <div class="spd-wrap"><label>Speed</label><input type="range" id="spd" min="0.8" max="1.3" step="0.05" value="1.0"></div>
    </div>
    <div class="img-pv" id="img-pv">
      <img id="img-pv-src">
      <button class="rm" id="img-rm">&times;</button>
    </div>
    <div class="inp-row">
      <button class="circle-btn ib" id="ib" title="이미지 추가">&#x1f4f7;</button>
      <button class="circle-btn mic-btn" id="mic-btn" title="음성 입력">&#x1f3a4;</button>
      <textarea id="ta" rows="1" placeholder="메시지를 입력하세요..." disabled></textarea>
      <button class="circle-btn sb" id="sb" disabled>&#x2191;</button>
    </div>
    <input type="file" id="fi" accept="image/*" hidden>
  </div>
</div>

<!-- ===== SETTINGS ===== -->
<div class="ov" id="ov">
  <div class="pan">
    <div class="pan-handle"></div>
    <h3>설정</h3>
    <div class="sr">
      <div><div class="sl">자동 음성 읽기</div><div class="sd">AI 응답을 자동으로 읽어줍니다</div></div>
      <button class="tg on" id="tg-auto"></button>
    </div>
    <div class="sr">
      <div><div class="sl">음성 인식 언어</div><div class="sd">마이크 입력 언어</div></div>
      <select id="stt-lang" style="font-size:13px;padding:4px 8px;border-radius:8px;border:1px solid var(--border);font-family:inherit">
        <option value="ko-KR">한국어</option>
        <option value="en-US">English</option>
        <option value="ja-JP">日本語</option>
      </select>
    </div>
    <div class="sr">
      <div><div class="sl">TTS 엔진</div><div class="sd" id="tts-engine-info">-</div></div>
    </div>
    <div class="sr" style="border-bottom:none;justify-content:center">
      <button onclick="document.getElementById('ov').classList.remove('on')"
        style="padding:10px 32px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 2px 8px rgba(212,97,79,.25)">
        완료
      </button>
    </div>
  </div>
</div>

<script type="module">
import {
  pipeline, TextStreamer, InterruptableStoppingCriteria,
} from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@next";

/* ===== CONFIG ===== */
const MODELS = {
  lfm: {
    id: "LiquidAI/LFM2.5-1.2B-Instruct-ONNX",
    name: "LFM2.5 1.2B", icon: "\u{1f9e0}", desc: "한국어 추천, 고성능",
    size: "~700 MB", lang: "KO / EN",
    dtype: "q4f16", task: "text-generation",
    sample: true, temp: 0.7, maxTokens: 512,
  },
  falcon: {
    id: "onnx-community/Falcon-H1-Tiny-90M-Instruct-ONNX",
    name: "Falcon 90M", icon: "\u26a1", desc: "초경량, 빠른 응답",
    size: "~180 MB", lang: "EN / KO",
    dtype: "fp16", task: "text-generation",
    sample: false, maxTokens: 512,
  },
  vlm: {
    id: "LiquidAI/LFM2.5-VL-1.6B-ONNX",
    name: "LFM2.5-VL 1.6B", icon: "\u{1f441}\ufe0f", desc: "이미지 인식 + 대화",
    size: "~1 GB", lang: "Vision + Text",
    dtype: "q4f16", task: "image-text-to-text",
    sample: true, temp: 0.7, maxTokens: 256, isVL: true,
  },
};

const TTS_ID = "onnx-community/Supertonic-TTS-2-ONNX";
const TTS_VOICE_BASE = "https://huggingface.co/onnx-community/Supertonic-TTS-2-ONNX/resolve/main/voices";

const SYS = {
  role: "system",
  content: "너는 SAGI라는 친절한 AI 어시스턴트야. 간결하고 자연스럽게 답해. 사용자가 한국어로 말하면 한국어로, 영어로 말하면 영어로 답해.",
};

/* ===== STATE ===== */
let gen = null, tts = null, ttsMode = "webspeech", msgs = [SYS];
let busy = false, autoSpeak = true, curKey = null;
let audioCtx = null, curSrc = null, pendImg = null;
let selectedVoice = "F1";
const stop = new InterruptableStoppingCriteria();

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const chat = $("chat"), ta = $("ta"), sb = $("sb");
const ib = $("ib"), fi = $("fi"), imgPv = $("img-pv"), imgSrc = $("img-pv-src");
const micBtn = $("mic-btn");

/* ===== CLEANUP: force-remove old COI SW that blocks Workers ===== */
if ("serviceWorker" in navigator && window.crossOriginIsolated) {
  navigator.serviceWorker.getRegistrations().then(async regs => {
    for (const r of regs) await r.unregister();
    sessionStorage.removeItem("coi");
    location.reload();
  });
}

/* ===== MODEL CARDS ===== */
const ce = $("cards");
for (const [k, m] of Object.entries(MODELS)) {
  const c = document.createElement("div");
  c.className = "card";
  c.innerHTML = `<span class="ic">${m.icon}</span><div class="nm">${m.name}</div>
    <div class="ds">${m.desc}</div>
    <div class="meta"><span class="sz">${m.size}</span><span class="lang">${m.lang}</span></div>
    ${m.isVL ? '<div class="badge">Vision</div>' : ""}`;
  c.onclick = () => load(k);
  ce.appendChild(c);
}

function show(n) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  $(n + "-screen").classList.add("active");
}

/* ===== VOICE BAR ===== */
document.querySelectorAll(".vchip").forEach(chip => {
  chip.addEventListener("click", () => {
    document.querySelectorAll(".vchip").forEach(c => c.classList.remove("sel"));
    chip.classList.add("sel");
    selectedVoice = chip.dataset.v;
  });
});

/* ===== LOAD ===== */
async function load(key) {
  curKey = key;
  const m = MODELS[key];
  show("loading");
  $("ld-title").textContent = `${m.name} 로딩 중...`;
  $("ld-status").textContent = "WebGPU 초기화 중...";
  $("llm-bar").style.width = "0%"; $("llm-pct").textContent = "0%";
  $("tts-bar").style.width = "0%"; $("tts-pct").textContent = "0%";

  const lf = new Map(), tf = new Map();
  const ub = (f, bid, pid) => {
    if (f.size < 2) return;
    let ld = 0, tt = 0;
    for (const v of f.values()) { ld += v.loaded; tt += v.total; }
    const p = tt > 0 ? Math.round(ld/tt*100) : 0;
    $(bid).style.width = p + "%"; $(pid).textContent = p + "%";
  };

  // LLM
  try {
    $("ld-status").textContent = `${m.name} 다운로드 중...`;
    gen = await pipeline(m.task, m.id, {
      dtype: m.dtype, device: "webgpu",
      progress_callback: ({status,file,loaded,total}) => {
        if (status==="progress") { lf.set(file,{loaded,total}); ub(lf,"llm-bar","llm-pct"); }
      },
    });
  } catch(e) {
    console.warn("WebGPU fail, WASM fallback:", e);
    $("ld-status").textContent = "WebGPU 불가, WASM 모드...";
    lf.clear();
    gen = await pipeline(m.task, m.id, {
      dtype: m.dtype==="fp16"?"fp32":"q4", device: "wasm",
      progress_callback: ({status,file,loaded,total}) => {
        if (status==="progress") { lf.set(file,{loaded,total}); ub(lf,"llm-bar","llm-pct"); }
      },
    });
  }
  $("llm-bar").style.width = "100%"; $("llm-pct").textContent = "100%";

  // TTS: Supertonic-2 via transformers.js v3.8 (v4 dropped Supertonic model class)
  $("tts-bar-group").style.display = "";
  $("ld-status").textContent = "음성 엔진 준비 중...";
  try {
    const { pipeline: ttsPipeline } = await import(
      "https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.1"
    );
    $("ld-status").textContent = "Supertonic TTS 다운로드 중...";
    tts = await ttsPipeline("text-to-speech", TTS_ID, {
      dtype: "fp32",
      progress_callback: ({status,file,loaded,total}) => {
        if (status==="progress") { tf.set(file,{loaded,total}); ub(tf,"tts-bar","tts-pct"); }
      },
    });
    ttsMode = "supertonic";
    console.log("Supertonic TTS loaded OK (v3.8.1)");
  } catch(e) {
    console.warn("Supertonic TTS failed:", e);
    tts = null;
    ttsMode = window.speechSynthesis ? "webspeech" : "none";
    console.log("TTS fallback:", ttsMode);
  }
  $("tts-bar").style.width = "100%";
  $("tts-pct").textContent = ttsMode === "supertonic" ? "100%" : ttsMode === "webspeech" ? "Web" : "N/A";
  $("tts-engine-info").textContent = ttsMode === "supertonic" ? "Supertonic TTS 2 (ONNX)" : ttsMode === "webspeech" ? "Web Speech API (브라우저 내장)" : "없음";

  // Ready
  $("hdr-sub").textContent = `${m.name} · ${ttsMode === "supertonic" ? "Supertonic" : "Web Speech"}`;
  if (m.isVL) ib.classList.add("vis");
  ta.disabled = false; ta.focus();
  show("chat");
  welcome();
}

/* ===== MESSAGES ===== */
function welcome() {
  const m = MODELS[curKey];
  const t = m.isVL ? "안녕하세요! 이미지를 보내거나 질문해주세요."
    : "안녕하세요! 무엇이든 물어보세요.";
  addMsg("a", t);
}

function addMsg(role, text, imgUrl) {
  const d = document.createElement("div");
  d.className = `m ${role}`;
  const av = document.createElement("div");
  av.className = "m-av";
  av.textContent = role === "u" ? "U" : "S";
  const body = document.createElement("div");
  body.className = "m-body";
  const bub = document.createElement("div");
  bub.className = "m-bub";
  if (imgUrl) { const i = document.createElement("img"); i.src = imgUrl; bub.appendChild(i); }
  if (text) bub.appendChild(document.createTextNode(text));
  body.appendChild(bub);

  if (role === "a") {
    const act = document.createElement("div"); act.className = "m-act";
    const sp = document.createElement("button"); sp.className = "sp-btn";
    sp.textContent = "\u{1f50a}"; sp.title = "읽기";
    sp.onclick = () => { const t = bub.textContent; if (t?.trim()) speak(t, sp); };
    act.appendChild(sp); body.appendChild(act);
  }

  d.appendChild(av); d.appendChild(body);
  chat.appendChild(d);
  requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
  return bub;
}

function showDots() {
  const d = document.createElement("div");
  d.className = "m a"; d.id = "dots";
  d.innerHTML = `<div class="m-av">S</div><div class="m-body"><div class="m-bub"><div class="dots"><span></span><span></span><span></span></div></div></div>`;
  chat.appendChild(d);
  requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
}
function hideDots() { $("dots")?.remove(); }

/* ===== GENERATE ===== */
async function generate() {
  if (busy) { stop.interrupt(); return; }
  const text = ta.value.trim();
  const hasImg = !!pendImg;
  if (!text && !hasImg) return;

  const imgUrl = pendImg;
  ta.value = ""; ta.style.height = "auto"; clrImg(); updBtn();

  const m = MODELS[curKey];
  let content;
  if (m.isVL && hasImg) {
    content = [];
    content.push({ type: "image", image: imgUrl });
    content.push({ type: "text", text: text || "이 이미지를 설명해주세요." });
  } else {
    content = text;
  }

  msgs.push({ role: "user", content });
  addMsg("u", text || "(이미지)", hasImg ? imgUrl : null);
  showDots();

  busy = true; sb.classList.add("gen"); sb.innerHTML = "&#x25A0;"; stop.reset();
  hideDots();
  const bub = addMsg("a", "");
  let res = "";

  const opts = { max_new_tokens: m.maxTokens, do_sample: m.sample, stopping_criteria: stop };
  if (m.sample && m.temp) opts.temperature = m.temp;

  if (m.isVL) {
    try {
      const out = await gen(msgs, opts);
      res = typeof out === "string" ? out
        : Array.isArray(out) ? (out[0]?.generated_text ?? out[0]?.text ?? JSON.stringify(out))
        : (out?.generated_text ?? out?.text ?? JSON.stringify(out));
      if (typeof res === "object") res = JSON.stringify(res);
      bub.textContent = res;
    } catch(e) {
      console.error("VL error:", e);
      bub.textContent = "(오류: " + e.message + ")";
    }
  } else {
    opts.streamer = new TextStreamer(gen.tokenizer, {
      skip_prompt: true, skip_special_tokens: true,
      callback_function: tok => {
        res += tok; bub.textContent = res;
        requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight);
      },
    });
    try { await gen(msgs, opts); }
    catch(e) { console.error("Gen error:", e); if (!res) bub.textContent = "(생성 실패)"; }
  }

  msgs.push({ role: "assistant", content: res });
  busy = false; sb.classList.remove("gen"); sb.innerHTML = "&#x2191;"; updBtn(); ta.focus();

  if (autoSpeak && res.trim()) {
    const sp = bub.closest(".m-body")?.querySelector(".sp-btn");
    speak(res, sp);
  }
}

/* ===== IMAGE ===== */
function attachImg(url) { pendImg = url; imgSrc.src = url; imgPv.classList.add("on"); updBtn(); }
function clrImg() { pendImg = null; imgSrc.src = ""; imgPv.classList.remove("on"); }
ib.addEventListener("click", () => fi.click());
fi.addEventListener("change", e => {
  const f = e.target.files?.[0]; if (!f) return;
  const r = new FileReader(); r.onload = () => attachImg(r.result); r.readAsDataURL(f);
  fi.value = "";
});
$("img-rm").addEventListener("click", clrImg);
document.addEventListener("paste", e => {
  if (!MODELS[curKey]?.isVL) return;
  for (const it of e.clipboardData?.items || []) {
    if (it.type.startsWith("image/")) {
      e.preventDefault();
      const r = new FileReader(); r.onload = () => attachImg(r.result);
      r.readAsDataURL(it.getAsFile()); break;
    }
  }
});

/* ===== TTS ===== */
function detectLang(t) { return /[\u3131-\u3163\uac00-\ud7a3]/.test(t) ? "ko" : "en"; }

async function speak(text, btn) {
  // Stop any current playback first
  stopSpeaking();
  if (btn) btn.classList.add("speaking");

  if (ttsMode === "supertonic" && tts) {
    try {
      const lang = detectLang(text);
      const speed = parseFloat($("spd")?.value || "1.0");
      const r = await tts(`<${lang}>${text}</${lang}>`, {
        speaker_embeddings: `${TTS_VOICE_BASE}/${selectedVoice}.bin`,
        num_inference_steps: 5, speed,
      });
      if (!audioCtx) audioCtx = new AudioContext();
      const buf = audioCtx.createBuffer(1, r.audio.length, r.sampling_rate);
      buf.getChannelData(0).set(r.audio);
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.connect(audioCtx.destination);
      curSrc = src;
      src.onended = () => { if (btn) btn.classList.remove("speaking"); curSrc = null; };
      src.start();
    } catch(e) {
      console.warn("Supertonic speak failed, falling back to Web Speech:", e);
      speakWebSpeech(text, btn);
    }
  } else {
    speakWebSpeech(text, btn);
  }
}

function speakWebSpeech(text, btn) {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const lang = detectLang(text);
  u.lang = lang === "ko" ? "ko-KR" : "en-US";
  u.rate = parseFloat($("spd")?.value || "1.0");
  u.onend = () => { if (btn) btn.classList.remove("speaking"); };
  u.onerror = () => { if (btn) btn.classList.remove("speaking"); };
  window.speechSynthesis.speak(u);
}

function stopSpeaking() {
  if (curSrc) { try { curSrc.stop(); } catch{} curSrc = null; }
  window.speechSynthesis?.cancel();
  document.querySelectorAll(".sp-btn.speaking").forEach(b => b.classList.remove("speaking"));
}

/* ===== SPEECH RECOGNITION ===== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;

  recognition.onstart = () => {
    isRecording = true;
    micBtn.classList.add("rec");
    micBtn.title = "녹음 중... (클릭하여 중지)";
    ta.placeholder = "듣고 있어요...";
  };

  recognition.onresult = (e) => {
    let interim = "", final = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t;
      else interim += t;
    }
    if (final) {
      ta.value = (ta.value ? ta.value + " " : "") + final;
      ta.style.height = "auto";
      ta.style.height = Math.min(ta.scrollHeight, 100) + "px";
      updBtn();
    } else if (interim) {
      ta.placeholder = interim;
    }
  };

  recognition.onend = () => {
    isRecording = false;
    micBtn.classList.remove("rec");
    micBtn.title = "음성 입력";
    ta.placeholder = "메시지를 입력하세요...";
    // Auto-send if we got text
    if (ta.value.trim()) {
      generate();
    }
  };

  recognition.onerror = (e) => {
    console.warn("Speech recognition error:", e.error);
    isRecording = false;
    micBtn.classList.remove("rec");
    ta.placeholder = "메시지를 입력하세요...";
    if (e.error === "not-allowed") {
      micBtn.title = "마이크 권한이 필요합니다";
    }
  };
} else {
  micBtn.style.display = "none";
}

micBtn.addEventListener("click", () => {
  if (!recognition) return;
  if (isRecording) {
    recognition.stop();
  } else {
    recognition.lang = $("stt-lang")?.value || "ko-KR";
    try { recognition.start(); }
    catch(e) { console.warn("Recognition start failed:", e); }
  }
});

/* ===== EVENTS ===== */
sb.addEventListener("click", generate);
ta.addEventListener("keydown", e => { if (e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); generate(); }});
ta.addEventListener("input", () => {
  ta.style.height = "auto"; ta.style.height = Math.min(ta.scrollHeight, 100) + "px"; updBtn();
});
function updBtn() { sb.disabled = (!ta.value.trim() && !pendImg) && !busy; }

// TTS toggle
const ttsBtn = $("tts-btn");
ttsBtn.addEventListener("click", () => {
  autoSpeak = !autoSpeak;
  ttsBtn.classList.toggle("on", autoSpeak);
  $("tg-auto").classList.toggle("on", autoSpeak);
  if (!autoSpeak) stopSpeaking();
});
$("tg-auto").addEventListener("click", function() {
  autoSpeak = !autoSpeak;
  this.classList.toggle("on", autoSpeak);
  ttsBtn.classList.toggle("on", autoSpeak);
});

$("set-btn").addEventListener("click", () => $("ov").classList.add("on"));
$("ov").addEventListener("click", e => { if (e.target === $("ov")) $("ov").classList.remove("on"); });

chat.addEventListener("dblclick", () => {
  if (busy) return;
  if (confirm("대화 기록을 삭제할까요?")) { msgs = [SYS]; chat.innerHTML = ""; welcome(); }
});
</script>
</body>
</html>
