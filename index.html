<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#FDF6F0">
<title>SAGI</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23E8756B'/><stop offset='1' stop-color='%23D4614F'/></linearGradient></defs><rect width='200' height='200' rx='44' fill='url(%23g)'/><circle cx='78' cy='100' r='18' fill='white'/><path d='M112 72Q128 100 112 128' stroke='white' stroke-width='6' fill='none' stroke-linecap='round'/><path d='M128 58Q152 100 128 142' stroke='white' stroke-width='6' fill='none' stroke-linecap='round' opacity='.6'/></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#FDF6F0;--surface:#fff;--accent:#E8756B;--accent-dark:#D4614F;
  --accent-light:#FFF0ED;--text:#1D1D1F;--text-sec:#86868B;
  --border:rgba(0,0,0,.06);--radius:20px;--shadow:0 2px 16px rgba(0,0,0,.06);
}
html,body{height:100%;overflow:hidden}
body{
  font-family:-apple-system,'SF Pro Display','Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;
}
.screen{display:none;flex-direction:column;height:100dvh;position:absolute;inset:0;z-index:1}
.screen.active{display:flex}

/* ===== MODEL SELECT ===== */
#select-screen{
  align-items:center;justify-content:center;gap:32px;padding:24px;
  background:linear-gradient(180deg,#FDF6F0 0%,#FFF0ED 100%);
}
.select-logo{width:80px;height:80px}
.select-title{font-size:28px;font-weight:700;letter-spacing:-.5px}
.select-sub{font-size:15px;color:var(--text-sec);text-align:center;max-width:320px;line-height:1.5}
.model-cards{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:560px;width:100%}
.model-card{
  flex:1;min-width:200px;max-width:260px;background:var(--surface);
  border-radius:16px;padding:24px 20px;cursor:pointer;border:2px solid transparent;
  box-shadow:var(--shadow);transition:all .2s;text-align:center;
}
.model-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 24px rgba(232,117,107,.15)}
.model-card .icon{font-size:36px;margin-bottom:12px}
.model-card .name{font-size:17px;font-weight:600;margin-bottom:4px}
.model-card .desc{font-size:13px;color:var(--text-sec);margin-bottom:8px}
.model-card .size{font-size:12px;color:var(--accent);font-weight:500;
  background:var(--accent-light);padding:4px 10px;border-radius:20px;display:inline-block}
.tts-note{font-size:12px;color:var(--text-sec);text-align:center;margin-top:-8px}

/* ===== LOADING ===== */
#loading-screen{align-items:center;justify-content:center;gap:24px;
  background:linear-gradient(180deg,#FDF6F0 0%,#FFF0ED 100%)}
.loading-logo{width:72px;height:72px;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.85}}
.loading-title{font-size:20px;font-weight:600}
.loading-bars{width:280px;display:flex;flex-direction:column;gap:12px}
.bar-group label{font-size:12px;color:var(--text-sec);display:flex;justify-content:space-between;margin-bottom:4px}
.bar-track{height:6px;background:rgba(0,0,0,.06);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-dark));
  border-radius:3px;transition:width .3s;width:0%}
.loading-status{font-size:13px;color:var(--text-sec)}

/* ===== CHAT ===== */
#chat-screen{background:var(--bg)}
.chat-header{
  display:flex;align-items:center;gap:10px;padding:12px 16px;
  background:rgba(253,246,240,.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);z-index:10;
  padding-top:max(12px,env(safe-area-inset-top));
}
.chat-header svg{width:32px;height:32px;flex-shrink:0}
.chat-header .title{font-size:17px;font-weight:600;flex:1}
.chat-header .model-tag{font-size:11px;color:var(--accent);background:var(--accent-light);
  padding:3px 8px;border-radius:10px;font-weight:500}
.header-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;
  color:var(--text-sec);transition:all .15s;font-size:18px}
.header-btn:hover{background:rgba(0,0,0,.05)}
.header-btn.active{color:var(--accent)}

.chat-area{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;
  scroll-behavior:smooth;overscroll-behavior:contain}

.msg{display:flex;gap:8px;max-width:85%;animation:msgIn .25s ease-out}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg.assistant{align-self:flex-start}
.msg-avatar{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;
  align-items:center;justify-content:center;font-size:14px}
.msg.user .msg-avatar{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:white}
.msg.assistant .msg-avatar{background:#F0EBE3;color:#8E8E93}
.msg-body{display:flex;flex-direction:column;gap:4px}
.msg-bubble{padding:10px 14px;border-radius:18px;font-size:15px;line-height:1.5;word-break:break-word}
.msg.user .msg-bubble{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:white;
  border-bottom-right-radius:6px}
.msg.assistant .msg-bubble{background:var(--surface);border-bottom-left-radius:6px;
  box-shadow:0 1px 4px rgba(0,0,0,.04)}
.msg-actions{display:flex;gap:4px;padding:0 4px}
.msg.user .msg-actions{justify-content:flex-end}
.speak-btn{background:none;border:none;cursor:pointer;padding:2px 6px;border-radius:6px;
  font-size:14px;color:var(--text-sec);transition:all .15s}
.speak-btn:hover{background:rgba(0,0,0,.05);color:var(--accent)}
.speak-btn.speaking{color:var(--accent);animation:pulse 1s ease-in-out infinite}

.typing{display:flex;gap:4px;padding:10px 14px;align-items:center}
.typing span{width:6px;height:6px;border-radius:50%;background:var(--text-sec);
  animation:typing 1.2s ease-in-out infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}

.input-area{
  display:flex;align-items:flex-end;gap:8px;padding:12px 16px;
  background:rgba(253,246,240,.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding-bottom:max(12px,env(safe-area-inset-bottom));
}
.input-area textarea{
  flex:1;resize:none;border:none;outline:none;background:var(--surface);
  border-radius:22px;padding:10px 16px;font-size:15px;font-family:inherit;
  max-height:120px;line-height:1.4;box-shadow:0 1px 4px rgba(0,0,0,.04);
}
.input-area textarea::placeholder{color:var(--text-sec)}
.send-btn{
  width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:white;
  font-size:18px;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;
}
.send-btn:disabled{opacity:.3;cursor:default}
.send-btn:not(:disabled):hover{transform:scale(1.05);box-shadow:0 2px 12px rgba(232,117,107,.3)}
.send-btn.generating{background:linear-gradient(135deg,#FF9500,#FF6B00)}

/* ===== SETTINGS PANEL ===== */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100;
  display:none;align-items:flex-end;justify-content:center}
.settings-overlay.active{display:flex}
.settings-panel{
  background:var(--surface);border-radius:20px 20px 0 0;padding:24px;width:100%;max-width:480px;
  max-height:60vh;overflow-y:auto;animation:slideUp .3s ease-out;
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:none}}
.settings-panel h3{font-size:17px;font-weight:600;margin-bottom:16px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;
  border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:15px}
.setting-desc{font-size:12px;color:var(--text-sec)}
.toggle{width:44px;height:26px;border-radius:13px;background:#ccc;cursor:pointer;
  position:relative;transition:background .2s;border:none;padding:0;flex-shrink:0}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;
  background:white;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.toggle.on::after{transform:translateX(18px)}

/* ===== RESPONSIVE ===== */
@media(max-width:480px){
  .model-cards{flex-direction:column;align-items:center}
  .model-card{max-width:100%}
  .msg{max-width:90%}
}
</style>
</head>
<body>

<!-- ===== MODEL SELECT ===== -->
<div id="select-screen" class="screen active">
  <svg class="select-logo" viewBox="0 0 200 200">
    <defs><linearGradient id="lg1" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
    </linearGradient></defs>
    <rect width="200" height="200" rx="44" fill="url(#lg1)"/>
    <circle cx="78" cy="100" r="18" fill="white"/>
    <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
  </svg>
  <div class="select-title">SAGI</div>
  <div class="select-sub">AI voice assistant running entirely in your browser. Choose a model to begin.</div>
  <div class="model-cards" id="model-cards"></div>
  <div class="tts-note">+ Supertonic-2 Korean/English TTS</div>
</div>

<!-- ===== LOADING ===== -->
<div id="loading-screen" class="screen">
  <svg class="loading-logo" viewBox="0 0 200 200">
    <defs><linearGradient id="lg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
    </linearGradient></defs>
    <rect width="200" height="200" rx="44" fill="url(#lg2)"/>
    <circle cx="78" cy="100" r="18" fill="white"/>
    <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    <path d="M144 44Q176 100 144 156" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".3"/>
  </svg>
  <div class="loading-title" id="loading-title">Loading...</div>
  <div class="loading-bars">
    <div class="bar-group">
      <label><span>Language Model</span><span id="llm-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="llm-bar"></div></div>
    </div>
    <div class="bar-group">
      <label><span>Voice Engine</span><span id="tts-pct">0%</span></label>
      <div class="bar-track"><div class="bar-fill" id="tts-bar"></div></div>
    </div>
  </div>
  <div class="loading-status" id="loading-status">Initializing WebGPU...</div>
</div>

<!-- ===== CHAT ===== -->
<div id="chat-screen" class="screen">
  <div class="chat-header">
    <svg viewBox="0 0 200 200" style="width:32px;height:32px">
      <defs><linearGradient id="lg3" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#E8756B"/><stop offset="1" stop-color="#D4614F"/>
      </linearGradient></defs>
      <rect width="200" height="200" rx="44" fill="url(#lg3)"/>
      <circle cx="78" cy="100" r="18" fill="white"/>
      <path d="M112 72Q128 100 112 128" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M128 58Q152 100 128 142" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" opacity=".6"/>
    </svg>
    <span class="title">SAGI</span>
    <span class="model-tag" id="model-tag"></span>
    <button class="header-btn" id="tts-toggle" title="Auto-speak">&#x1f50a;</button>
    <button class="header-btn" id="settings-btn" title="Settings">&#x2699;</button>
  </div>
  <div class="chat-area" id="chat-area"></div>
  <div class="input-area">
    <textarea id="input" rows="1" placeholder="Type a message..." disabled></textarea>
    <button class="send-btn" id="send-btn" disabled>&#x2191;</button>
  </div>
</div>

<!-- ===== SETTINGS ===== -->
<div class="settings-overlay" id="settings-overlay">
  <div class="settings-panel">
    <h3>Settings</h3>
    <div class="setting-row">
      <div>
        <div class="setting-label">Auto-speak responses</div>
        <div class="setting-desc">TTS reads AI replies aloud</div>
      </div>
      <button class="toggle on" id="toggle-autospeak"></button>
    </div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Voice</div>
        <div class="setting-desc">TTS speaker voice</div>
      </div>
      <select id="voice-select" style="font-size:14px;padding:4px 8px;border-radius:8px;border:1px solid var(--border)">
        <option value="F1">Female 1</option>
        <option value="F3">Female 3</option>
        <option value="F5">Female 5</option>
        <option value="M1">Male 1</option>
        <option value="M3">Male 3</option>
        <option value="M5">Male 5</option>
      </select>
    </div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Speech speed</div>
        <div class="setting-desc">TTS playback rate</div>
      </div>
      <input type="range" id="speed-range" min="0.8" max="1.3" step="0.05" value="1.0"
        style="width:100px;accent-color:var(--accent)">
    </div>
    <div class="setting-row" style="border-bottom:none;justify-content:center">
      <button onclick="document.getElementById('settings-overlay').classList.remove('active')"
        style="padding:10px 32px;border-radius:12px;border:none;background:var(--accent);color:white;font-size:15px;font-weight:500;cursor:pointer">
        Done
      </button>
    </div>
  </div>
</div>

<script type="module">
import {
  pipeline,
  TextStreamer,
  InterruptableStoppingCriteria,
} from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@next";

/* ===== CONFIG ===== */
const MODELS = {
  falcon: {
    id: "onnx-community/Falcon-H1-Tiny-90M-Instruct-ONNX",
    name: "Falcon 90M", icon: "\u26a1", desc: "Fast & Light", size: "~180 MB",
    dtype: "fp16", sample: false, maxTokens: 512,
  },
  lfm: {
    id: "onnx-community/LFM2-1.2B-ONNX",
    name: "LFM2 1.2B", icon: "\u{1f9e0}", desc: "Smart & Capable", size: "~700 MB",
    dtype: "q4f16", sample: true, temp: 0.7, maxTokens: 512,
  },
};

const TTS_ID = "onnx-community/Supertonic-TTS-2-ONNX";
const TTS_VOICE_BASE = "https://huggingface.co/onnx-community/Supertonic-TTS-2-ONNX/resolve/main/voices";

const SYSTEM_MSG = {
  role: "system",
  content: "You are SAGI, a warm and thoughtful AI assistant. Be concise, natural, and helpful. Respond in the same language the user writes in. Keep answers brief unless asked for detail.",
};

/* ===== STATE ===== */
let generator = null;
let tts = null;
let messages = [SYSTEM_MSG];
let isGenerating = false;
let autoSpeak = true;
let currentModelKey = null;
let audioCtx = null;
let currentSource = null;
const stoppingCriteria = new InterruptableStoppingCriteria();

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const chatArea = $("chat-area");
const input = $("input");
const sendBtn = $("send-btn");

/* ===== COI SERVICE WORKER ===== */
if ("serviceWorker" in navigator && !window.crossOriginIsolated) {
  if (!sessionStorage.getItem("coi")) {
    sessionStorage.setItem("coi", "1");
    navigator.serviceWorker.register("coi-sw.js").then(() => location.reload());
  }
}

/* ===== MODEL SELECTION ===== */
const cardsEl = $("model-cards");
for (const [key, m] of Object.entries(MODELS)) {
  const card = document.createElement("div");
  card.className = "model-card";
  card.innerHTML = `<div class="icon">${m.icon}</div>
    <div class="name">${m.name}</div>
    <div class="desc">${m.desc}</div>
    <div class="size">${m.size}</div>`;
  card.onclick = () => loadModels(key);
  cardsEl.appendChild(card);
}

function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  $(name + "-screen").classList.add("active");
}

/* ===== LOADING ===== */
async function loadModels(modelKey) {
  currentModelKey = modelKey;
  const model = MODELS[modelKey];
  showScreen("loading");
  $("loading-title").textContent = `Loading ${model.name}...`;
  $("loading-status").textContent = "Initializing WebGPU...";

  const llmFiles = new Map();
  const ttsFiles = new Map();

  function updateBar(files, barId, pctId) {
    if (files.size < 2) return;
    let loaded = 0, total = 0;
    for (const v of files.values()) { loaded += v.loaded; total += v.total; }
    const pct = total > 0 ? Math.round((loaded / total) * 100) : 0;
    $(barId).style.width = pct + "%";
    $(pctId).textContent = pct + "%";
  }

  try {
    // Load LLM
    $("loading-status").textContent = `Downloading ${model.name}...`;
    generator = await pipeline("text-generation", model.id, {
      dtype: model.dtype,
      device: "webgpu",
      progress_callback: ({ status, file, loaded, total }) => {
        if (status === "progress") {
          llmFiles.set(file, { loaded, total });
          updateBar(llmFiles, "llm-bar", "llm-pct");
        }
      },
    });
    $("llm-bar").style.width = "100%";
    $("llm-pct").textContent = "100%";
  } catch (e) {
    console.warn("WebGPU failed, trying WASM:", e);
    $("loading-status").textContent = "WebGPU unavailable, using WASM...";
    llmFiles.clear();
    generator = await pipeline("text-generation", model.id, {
      dtype: model.dtype === "fp16" ? "fp32" : "q4",
      device: "wasm",
      progress_callback: ({ status, file, loaded, total }) => {
        if (status === "progress") {
          llmFiles.set(file, { loaded, total });
          updateBar(llmFiles, "llm-bar", "llm-pct");
        }
      },
    });
    $("llm-bar").style.width = "100%";
    $("llm-pct").textContent = "100%";
  }

  // Load TTS
  try {
    $("loading-status").textContent = "Loading voice engine...";
    tts = await pipeline("text-to-speech", TTS_ID, {
      device: "wasm",
      progress_callback: ({ status, file, loaded, total }) => {
        if (status === "progress") {
          ttsFiles.set(file, { loaded, total });
          updateBar(ttsFiles, "tts-bar", "tts-pct");
        }
      },
    });
    $("tts-bar").style.width = "100%";
    $("tts-pct").textContent = "100%";
  } catch (e) {
    console.warn("TTS load failed:", e);
    $("loading-status").textContent = "Voice engine unavailable (chat still works)";
    tts = null;
    $("tts-bar").style.width = "100%";
    $("tts-pct").textContent = "N/A";
    await new Promise(r => setTimeout(r, 1500));
  }

  // Ready
  $("model-tag").textContent = model.name;
  input.disabled = false;
  input.focus();
  showScreen("chat");
  addWelcome();
}

/* ===== CHAT ===== */
function addWelcome() {
  addMsg("assistant", "Hi! I'm SAGI. How can I help you today?");
}

function addMsg(role, text) {
  const div = document.createElement("div");
  div.className = `msg ${role}`;

  const avatar = document.createElement("div");
  avatar.className = "msg-avatar";
  avatar.textContent = role === "user" ? "\u{1f464}" : "\u{1f50a}";

  const body = document.createElement("div");
  body.className = "msg-body";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  if (text) bubble.textContent = text;

  body.appendChild(bubble);

  if (role === "assistant" && tts) {
    const actions = document.createElement("div");
    actions.className = "msg-actions";
    const speakBtn = document.createElement("button");
    speakBtn.className = "speak-btn";
    speakBtn.textContent = "\u{1f50a}";
    speakBtn.title = "Speak";
    speakBtn.onclick = () => {
      const t = bubble.textContent;
      if (t && t.trim()) speak(t, speakBtn);
    };
    actions.appendChild(speakBtn);
    body.appendChild(actions);
  }

  div.appendChild(avatar);
  div.appendChild(body);
  chatArea.appendChild(div);
  scrollToBottom();
  return bubble;
}

function scrollToBottom() {
  requestAnimationFrame(() => chatArea.scrollTop = chatArea.scrollHeight);
}

function showTyping() {
  const div = document.createElement("div");
  div.className = "msg assistant";
  div.id = "typing-indicator";
  div.innerHTML = `<div class="msg-avatar">\u{1f50a}</div>
    <div class="msg-body"><div class="msg-bubble"><div class="typing">
      <span></span><span></span><span></span>
    </div></div></div>`;
  chatArea.appendChild(div);
  scrollToBottom();
}

function hideTyping() {
  const el = $("typing-indicator");
  if (el) el.remove();
}

/* ===== GENERATION ===== */
async function generate() {
  if (isGenerating) { stoppingCriteria.interrupt(); return; }

  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  input.style.height = "auto";
  updateSendBtn();

  messages.push({ role: "user", content: text });
  addMsg("user", text);
  showTyping();

  isGenerating = true;
  sendBtn.classList.add("generating");
  stoppingCriteria.reset();

  hideTyping();
  const contentEl = addMsg("assistant", "");
  let response = "";

  const model = MODELS[currentModelKey];
  const genOpts = {
    max_new_tokens: model.maxTokens,
    do_sample: model.sample,
    stopping_criteria: stoppingCriteria,
    streamer: new TextStreamer(generator.tokenizer, {
      skip_prompt: true,
      skip_special_tokens: true,
      callback_function: (token) => {
        response += token;
        contentEl.textContent = response;
        scrollToBottom();
      },
    }),
  };
  if (model.sample && model.temp) genOpts.temperature = model.temp;

  try {
    await generator(messages, genOpts);
  } catch (e) {
    console.error("Generation error:", e);
    if (!response) contentEl.textContent = "(Generation failed)";
  }

  messages.push({ role: "assistant", content: response });
  isGenerating = false;
  sendBtn.classList.remove("generating");
  updateSendBtn();
  input.focus();

  if (autoSpeak && tts && response.trim()) {
    const speakBtns = contentEl.closest(".msg-body")?.querySelectorAll(".speak-btn");
    const btn = speakBtns?.[0];
    speak(response, btn);
  }
}

/* ===== TTS ===== */
function detectLang(text) {
  return /[\u3131-\u3163\uac00-\ud7a3]/.test(text) ? "ko" : "en";
}

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

async function speak(text, btn) {
  if (!tts) return;
  if (currentSource) { try { currentSource.stop(); } catch {} currentSource = null; }
  if (btn) btn.classList.add("speaking");

  try {
    const lang = detectLang(text);
    const voice = $("voice-select")?.value || "F1";
    const speed = parseFloat($("speed-range")?.value || "1.0");

    const result = await tts(`<${lang}>${text}</${lang}>`, {
      speaker_embeddings: `${TTS_VOICE_BASE}/${voice}.bin`,
      num_inference_steps: 5,
      speed,
    });

    const ctx = getAudioCtx();
    const buffer = ctx.createBuffer(1, result.audio.length, result.sampling_rate);
    buffer.getChannelData(0).set(result.audio);
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.connect(ctx.destination);
    currentSource = source;
    source.onended = () => { if (btn) btn.classList.remove("speaking"); currentSource = null; };
    source.start();
  } catch (e) {
    console.error("TTS error:", e);
    if (btn) btn.classList.remove("speaking");
  }
}

/* ===== EVENT HANDLERS ===== */
sendBtn.addEventListener("click", generate);

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); generate(); }
});

input.addEventListener("input", () => {
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 120) + "px";
  updateSendBtn();
});

function updateSendBtn() {
  sendBtn.disabled = !input.value.trim() && !isGenerating;
}

// TTS toggle
const ttsToggle = $("tts-toggle");
ttsToggle.classList.toggle("active", autoSpeak);
ttsToggle.addEventListener("click", () => {
  autoSpeak = !autoSpeak;
  ttsToggle.classList.toggle("active", autoSpeak);
  $("toggle-autospeak").classList.toggle("on", autoSpeak);
});

$("toggle-autospeak").addEventListener("click", function() {
  autoSpeak = !autoSpeak;
  this.classList.toggle("on", autoSpeak);
  ttsToggle.classList.toggle("active", autoSpeak);
});

// Settings
$("settings-btn").addEventListener("click", () => $("settings-overlay").classList.add("active"));
$("settings-overlay").addEventListener("click", (e) => {
  if (e.target === $("settings-overlay")) $("settings-overlay").classList.remove("active");
});

// Clear chat
$("chat-area").addEventListener("dblclick", () => {
  if (isGenerating) return;
  if (confirm("Clear chat history?")) {
    messages = [SYSTEM_MSG];
    chatArea.innerHTML = "";
    addWelcome();
  }
});
</script>
</body>
</html>
